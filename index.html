import React, { useState, useEffect } from 'react';
import { AlertCircle, Check, Plus, Save, Trash2, FileText, ChevronLeft, ChevronRight, Download } from 'lucide-react';

const TriageFeedbackTool = () => {
  const [scenarios, setScenarios] = useState([]);
  const [currentScenarioIndex, setCurrentScenarioIndex] = useState(0);
  const [loading, setLoading] = useState(true);
  const [editMode, setEditMode] = useState(false);
  
  const [formData, setFormData] = useState({
    scenarioName: '',
    studentTriage: '',
    bestPractice: '',
    atsCategory: '',
    studentAtsCategory: ''
  });
  
  const [generatedFeedback, setGeneratedFeedback] = useState('');

  // Sample scenario for demonstration
  const sampleScenario = {
    id: Date.now(),
    scenarioName: "Chest Pain Presentation - SAMPLE",
    studentTriage: "Patient presents with chest pain. Pain started 2 hours ago. Patient looks uncomfortable. HR 95, BP 145/90. Patient rates pain 7/10.",
    bestPractice: "45-year-old male presents to ED with central crushing chest pain radiating to left arm. Pain onset 2 hours ago while at rest, described as 7/10 severity. Associated symptoms include nausea and diaphoresis. Past medical history includes hypertension and hyperlipidemia. Current medications: Amlodipine 10mg daily. No known drug allergies. Patient appears anxious and diaphoretic. Vital signs: HR 95 bpm, BP 145/90 mmHg, RR 20/min, SpO2 98% on room air, Temp 36.8°C. Primary survey: Airway patent, breathing adequate, circulation stable. ECG requested immediately. This presentation requires urgent assessment given age, cardiac risk factors, and nature of symptoms consistent with potential acute coronary syndrome.",
    atsCategory: "2",
    studentAtsCategory: "3",
    feedback: ""
  };

  // Load scenarios from storage
  useEffect(() => {
    loadScenarios();
  }, []);

  const loadScenarios = async () => {
    try {
      const result = await window.storage.get('triage-scenarios');
      if (result && result.value) {
        const loadedScenarios = JSON.parse(result.value);
        setScenarios(loadedScenarios);
        if (loadedScenarios.length > 0) {
          loadScenario(loadedScenarios[0]);
        }
      } else {
        // If no scenarios exist, load the sample
        const samplesArray = [sampleScenario];
        await window.storage.set('triage-scenarios', JSON.stringify(samplesArray));
        setScenarios(samplesArray);
        loadScenario(sampleScenario);
      }
    } catch (error) {
      console.log('Loading sample scenario');
      setScenarios([sampleScenario]);
      loadScenario(sampleScenario);
    } finally {
      setLoading(false);
    }
  };

  const loadSampleScenario = async () => {
    const updatedScenarios = [...scenarios, sampleScenario];
    await saveScenarios(updatedScenarios);
    setCurrentScenarioIndex(updatedScenarios.length - 1);
    loadScenario(sampleScenario);
  };

  const saveScenarios = async (updatedScenarios) => {
    try {
      await window.storage.set('triage-scenarios', JSON.stringify(updatedScenarios));
      setScenarios(updatedScenarios);
    } catch (error) {
      console.error('Error saving scenarios:', error);
      alert('Failed to save scenarios. Please try again.');
    }
  };

  const loadScenario = (scenario) => {
    setFormData({
      scenarioName: scenario.scenarioName,
      studentTriage: scenario.studentTriage,
      bestPractice: scenario.bestPractice,
      atsCategory: scenario.atsCategory,
      studentAtsCategory: scenario.studentAtsCategory
    });
    setGeneratedFeedback(scenario.feedback || '');
  };

  const addNewScenario = () => {
    if (scenarios.length >= 10) {
      alert('Maximum of 10 scenarios reached');
      return;
    }
    setFormData({
      scenarioName: `Scenario ${scenarios.length + 1}`,
      studentTriage: '',
      bestPractice: '',
      atsCategory: '',
      studentAtsCategory: ''
    });
    setGeneratedFeedback('');
    setEditMode(true);
    setCurrentScenarioIndex(scenarios.length);
  };

  const saveCurrentScenario = async () => {
    if (!formData.scenarioName.trim()) {
      alert('Please provide a scenario name');
      return;
    }

    const newScenario = {
      id: currentScenarioIndex < scenarios.length ? scenarios[currentScenarioIndex].id : Date.now(),
      ...formData,
      feedback: generatedFeedback
    };

    let updatedScenarios;
    if (currentScenarioIndex < scenarios.length) {
      updatedScenarios = [...scenarios];
      updatedScenarios[currentScenarioIndex] = newScenario;
    } else {
      updatedScenarios = [...scenarios, newScenario];
    }

    await saveScenarios(updatedScenarios);
    setEditMode(false);
  };

  const deleteScenario = async () => {
    if (!confirm('Are you sure you want to delete this scenario?')) return;
    
    const updatedScenarios = scenarios.filter((_, index) => index !== currentScenarioIndex);
    await saveScenarios(updatedScenarios);
    
    const newIndex = Math.max(0, currentScenarioIndex - 1);
    setCurrentScenarioIndex(newIndex);
    if (updatedScenarios.length > 0) {
      loadScenario(updatedScenarios[newIndex]);
    } else {
      setFormData({
        scenarioName: '',
        studentTriage: '',
        bestPractice: '',
        atsCategory: '',
        studentAtsCategory: ''
      });
      setGeneratedFeedback('');
    }
  };

  const navigateScenario = (direction) => {
    const newIndex = direction === 'next' 
      ? Math.min(scenarios.length - 1, currentScenarioIndex + 1)
      : Math.max(0, currentScenarioIndex - 1);
    
    setCurrentScenarioIndex(newIndex);
    loadScenario(scenarios[newIndex]);
    setEditMode(false);
  };

  const generateFeedback = () => {
    if (!formData.studentTriage || !formData.bestPractice) {
      alert('Please provide both student triage and best practice example');
      return;
    }

    const feedback = analyzeTriage(
      formData.studentTriage,
      formData.bestPractice,
      formData.atsCategory,
      formData.studentAtsCategory
    );
    
    setGeneratedFeedback(feedback);
  };

  const analyzeTriage = (studentText, bestPracticeText, correctAts, studentAts) => {
    let feedbackParts = [];
    
    // Opening - affirming and learner-centered
    feedbackParts.push("Thank you for your thorough approach to this triage scenario.");
    
    // ATS Category Assessment
    if (studentAts && correctAts) {
      if (studentAts.toLowerCase() === correctAts.toLowerCase()) {
        feedbackParts.push(`You correctly identified this as an ATS Category ${correctAts} presentation, demonstrating good clinical judgment regarding urgency.`);
      } else {
        feedbackParts.push(`I noticed you triaged this as Category ${studentAts}. Let's explore this together - the clinical indicators suggest this presentation aligns more closely with Category ${correctAts}. Consider what specific factors might elevate or reduce the urgency in this case.`);
      }
    }
    
    // Identify strengths
    const strengths = identifyStrengths(studentText, bestPracticeText);
    if (strengths.length > 0) {
      feedbackParts.push(`You demonstrated strong clinical reasoning in several areas: ${strengths.join(', ')}.`);
    }
    
    // Identify gaps constructively
    const gaps = identifyGaps(studentText, bestPracticeText);
    if (gaps.length > 0) {
      feedbackParts.push(`To strengthen your triage assessment, consider incorporating: ${gaps.join('; ')}. These elements can help build a more comprehensive clinical picture and support priority decision-making.`);
    }
    
    // Accuracy check
    const accuracyIssues = checkAccuracy(studentText, bestPracticeText);
    if (accuracyIssues.length > 0) {
      feedbackParts.push(`I'd like to revisit a few clinical details with you: ${accuracyIssues.join('; ')}. Accurate documentation of these findings is essential for safe handover and ongoing care.`);
    }
    
    // Closing - forward-focused and encouraging
    feedbackParts.push("Your engagement with this scenario shows developing clinical judgment. As you continue practicing triage, focus on systematically gathering key physiological, historical, and contextual information to support your urgency decisions. What questions do you have about this assessment?");
    
    return feedbackParts.join(' ');
  };

  const identifyStrengths = (studentText, bestPracticeText) => {
    const strengths = [];
    const student = studentText.toLowerCase();
    const bestPractice = bestPracticeText.toLowerCase();
    
    if (student.includes('vital signs') || student.includes('bp') || student.includes('heart rate') || student.includes('respiratory rate') || student.includes('hr')) {
      strengths.push('inclusion of vital signs assessment');
    }
    if (student.includes('pain') && bestPractice.includes('pain')) {
      strengths.push('pain assessment and documentation');
    }
    if (student.includes('history') || student.includes('onset') || student.includes('started')) {
      strengths.push('gathering relevant history');
    }
    if (student.includes('allerg') && bestPractice.includes('allerg')) {
      strengths.push('checking for allergies');
    }
    if (student.includes('medication') && bestPractice.includes('medication')) {
      strengths.push('medication history');
    }
    if (student.includes('uncomfortable') || student.includes('anxious') || student.includes('distress') || student.includes('looks')) {
      strengths.push('observation of patient appearance and distress level');
    }
    
    return strengths;
  };

  const identifyGaps = (studentText, bestPracticeText) => {
    const gaps = [];
    const student = studentText.toLowerCase();
    const bestPractice = bestPracticeText.toLowerCase();
    
    const keyElements = [
      { term: ['airway', 'breathing', 'circulation', 'primary survey'], label: 'primary survey elements (airway, breathing, circulation)' },
      { term: ['spo2', 'oxygen saturation', 'o2'], label: 'oxygen saturation measurement' },
      { term: ['respiratory rate', 'rr', 'respirations'], label: 'respiratory rate documentation' },
      { term: ['temperature', 'temp'], label: 'temperature measurement' },
      { term: ['pain scale', 'pain score', '/10'], label: 'pain assessment using appropriate scale' },
      { term: ['radiation', 'radiating'], label: 'radiation or location characteristics of pain' },
      { term: ['associated symptoms', 'nausea', 'vomiting', 'diaphoresis', 'sweating'], label: 'associated symptoms' },
      { term: ['past medical', 'pmh', 'history', 'medical history'], label: 'relevant past medical history' },
      { term: ['risk factor'], label: 'identification of relevant risk factors' },
      { term: ['allerg'], label: 'allergy status' },
      { term: ['medication', 'drugs', 'medicines'], label: 'current medications' },
      { term: ['at rest', 'exertion', 'activity', 'precipitating'], label: 'precipitating factors or context of symptom onset' },
      { term: ['age', 'year', 'male', 'female'], label: 'patient demographics' }
    ];
    
    keyElements.forEach(element => {
      const inBestPractice = element.term.some(term => bestPractice.includes(term));
      const inStudent = element.term.some(term => student.includes(term));
      
      if (inBestPractice && !inStudent) {
        gaps.push(element.label);
      }
    });
    
    return gaps;
  };

  const checkAccuracy = (studentText, bestPracticeText) => {
    const issues = [];
    
    // This is a simplified accuracy check
    const student = studentText.toLowerCase();
    
    // Check for vague descriptions
    if (student.includes('looks') && !student.includes('appears')) {
      issues.push('consider using more specific clinical descriptors rather than general observations');
    }
    
    return issues;
  };

  const exportScenarioTemplate = () => {
    const template = {
      scenarioName: "Enter scenario name here",
      bestPractice: "Enter the ideal/gold standard triage documentation here including: patient demographics, presenting complaint with onset and characteristics, vital signs (HR, BP, RR, SpO2, Temp), primary survey, past medical history, medications, allergies, associated symptoms, risk factors, and clinical reasoning for ATS category",
      atsCategory: "Enter correct ATS category (1-5)",
      notes: "This is a template. Fill in your scenario details. The student's triage and ATS category will be entered during assessment."
    };
    
    const dataStr = JSON.stringify(template, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'scenario-template.json';
    link.click();
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen bg-gray-50">
        <div className="text-lg text-gray-600">Loading scenarios...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
          <h1 className="text-3xl font-bold text-indigo-900 mb-2">Clinical Triage Feedback Tool</h1>
          <p className="text-gray-600">INACSL-aligned feedback generation for triage scenarios</p>
          
          {scenarios.length > 0 && scenarios[0].scenarioName.includes('SAMPLE') && (
            <div className="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <div className="flex items-start gap-3">
                <AlertCircle className="w-5 h-5 text-yellow-600 mt-1 flex-shrink-0" />
                <div>
                  <h3 className="font-semibold text-yellow-900 mb-1">Sample Scenario Loaded</h3>
                  <p className="text-sm text-yellow-800">
                    A demonstration scenario has been loaded to show you how the tool functions. 
                    Try clicking "Generate Feedback" to see the INACSL-aligned feedback in action. 
                    You can delete this sample and add your own scenarios when ready.
                  </p>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Navigation and Controls */}
        <div className="bg-white rounded-lg shadow-md p-4 mb-6">
          <div className="flex items-center justify-between flex-wrap gap-4">
            <div className="flex items-center gap-4">
              <button
                onClick={() => navigateScenario('prev')}
                disabled={currentScenarioIndex === 0 || scenarios.length === 0}
                className="p-2 rounded-lg bg-indigo-100 text-indigo-700 hover:bg-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed transition"
              >
                <ChevronLeft className="w-5 h-5" />
              </button>
              
              <div className="text-center">
                <div className="text-sm text-gray-500">Scenario</div>
                <div className="text-lg font-semibold text-gray-800">
                  {scenarios.length > 0 ? `${currentScenarioIndex + 1} of ${scenarios.length}` : '0 of 10'}
                </div>
              </div>
              
              <button
                onClick={() => navigateScenario('next')}
                disabled={currentScenarioIndex >= scenarios.length - 1 || scenarios.length === 0}
                className="p-2 rounded-lg bg-indigo-100 text-indigo-700 hover:bg-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed transition"
              >
                <ChevronRight className="w-5 h-5" />
              </button>
            </div>

            <div className="flex gap-2 flex-wrap">
              <button
                onClick={addNewScenario}
                disabled={scenarios.length >= 10}
                className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition"
              >
                <Plus className="w-4 h-4" />
                Add Scenario
              </button>
              
              {scenarios.length > 0 && (
                <>
                  <button
                    onClick={() => setEditMode(!editMode)}
                    className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
                  >
                    <FileText className="w-4 h-4" />
                    {editMode ? 'View Mode' : 'Edit Mode'}
                  </button>
                  
                  <button
                    onClick={deleteScenario}
                    className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
                  >
                    <Trash2 className="w-4 h-4" />
                    Delete
                  </button>
                </>
              )}
              
              <button
                onClick={exportScenarioTemplate}
                className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
              >
                <Download className="w-4 h-4" />
                Download Template
              </button>
            </div>
          </div>
        </div>

        {/* Main Content */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Input Section */}
          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Scenario Details</h2>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Scenario Name
                </label>
                <input
                  type="text"
                  value={formData.scenarioName}
                  onChange={(e) => setFormData({...formData, scenarioName: e.target.value})}
                  disabled={!editMode && scenarios.length > 0}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent disabled:bg-gray-100"
                  placeholder="e.g., Chest Pain Presentation"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Student's Triage Documentation
                </label>
                <textarea
                  value={formData.studentTriage}
                  onChange={(e) => setFormData({...formData, studentTriage: e.target.value})}
                  disabled={!editMode && scenarios.length > 0}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent h-32 disabled:bg-gray-100"
                  placeholder="Enter the student's written triage assessment..."
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Student's ATS Category
                </label>
                <select
                  value={formData.studentAtsCategory}
                  onChange={(e) => setFormData({...formData, studentAtsCategory: e.target.value})}
                  disabled={!editMode && scenarios.length > 0}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent disabled:bg-gray-100"
                >
                  <option value="">Select Category</option>
                  <option value="1">Category 1 - Immediate</option>
                  <option value="2">Category 2 - 10 minutes</option>
                  <option value="3">Category 3 - 30 minutes</option>
                  <option value="4">Category 4 - 60 minutes</option>
                  <option value="5">Category 5 - 120 minutes</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Best Practice Example
                </label>
                <textarea
                  value={formData.bestPractice}
                  onChange={(e) => setFormData({...formData, bestPractice: e.target.value})}
                  disabled={!editMode && scenarios.length > 0}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent h-32 disabled:bg-gray-100"
                  placeholder="Enter the ideal/best practice triage assessment..."
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Correct ATS Category
                </label>
                <select
                  value={formData.atsCategory}
                  onChange={(e) => setFormData({...formData, atsCategory: e.target.value})}
                  disabled={!editMode && scenarios.length > 0}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent disabled:bg-gray-100"
                >
                  <option value="">Select Category</option>
                  <option value="1">Category 1 - Immediate</option>
                  <option value="2">Category 2 - 10 minutes</option>
                  <option value="3">Category 3 - 30 minutes</option>
                  <option value="4">Category 4 - 60 minutes</option>
                  <option value="5">Category 5 - 120 minutes</option>
                </select>
              </div>

              {editMode && (
                <button
                  onClick={saveCurrentScenario}
                  className="w-full flex items-center justify-center gap-2 px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
                >
                  <Save className="w-4 h-4" />
                  Save Scenario
                </button>
              )}

              <button
                onClick={generateFeedback}
                className="w-full flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
              >
                <FileText className="w-4 h-4" />
                Generate Feedback
              </button>
            </div>
          </div>

          {/* Feedback Section */}
          <div className="bg-white rounded-lg shadow-md p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Generated Feedback</h2>
            
            {generatedFeedback ? (
              <div className="space-y-4">
                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                  <div className="flex items-start gap-3">
                    <Check className="w-5 h-5 text-green-600 mt-1 flex-shrink-0" />
                    <div>
                      <h3 className="font-semibold text-green-900 mb-2">INACSL-Aligned Feedback</h3>
                      <p className="text-gray-700 leading-relaxed whitespace-pre-wrap">{generatedFeedback}</p>
                    </div>
                  </div>
                </div>

                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <div className="flex items-start gap-3">
                    <AlertCircle className="w-5 h-5 text-blue-600 mt-1 flex-shrink-0" />
                    <div>
                      <h3 className="font-semibold text-blue-900 mb-2">Feedback Principles Applied</h3>
                      <ul className="text-sm text-gray-700 space-y-1">
                        <li>✓ Learner-centered and affirming</li>
                        <li>✓ Specific and evidence-based</li>
                        <li>✓ Constructive with growth focus</li>
                        <li>✓ Kind and respectful tone</li>
                        <li>✓ Actionable guidance provided</li>
                      </ul>
                    </div>
                  </div>
                </div>

                <button
                  onClick={() => {
                    navigator.clipboard.writeText(generatedFeedback);
                    alert('Feedback copied to clipboard!');
                  }}
                  className="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
                >
                  Copy Feedback to Clipboard
                </button>
              </div>
            ) : (
              <div className="flex items-center justify-center h-64 text-gray-400">
                <div className="text-center">
                  <FileText className="w-12 h-12 mx-auto mb-3 opacity-50" />
                  <p>Click "Generate Feedback" to create INACSL-aligned feedback</p>
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Footer Info */}
        <div className="mt-6 bg-white rounded-lg shadow-md p-4">
          <div className="text-sm text-gray-600">
            <strong>Note:</strong> This tool generates feedback aligned with INACSL standards emphasizing learner-centered, 
            constructive, and kind communication. All scenarios are saved automatically and persist between sessions. 
            You can download a scenario template using the "Download Template" button above.
          </div>
        </div>
      </div>
    </div>
  );
};

export default TriageFeedbackTool;
